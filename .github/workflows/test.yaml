---
name: Test
on:
  - push
permissions: {}
jobs:
  test-default:
    name: Test with default settings
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Setup Amber
        uses: ./
        with:
          amber-version: 0.4.0-alpha

      - name: Verify installation
        run: |
          which amber
          amber --version
          echo 'echo "Hello from Amber!"' > test.ab
          amber build test.ab
          bash test.sh

  test-custom-version:
    name: Test with custom version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - uses: ./
        with:
          amber-version: 0.5.0-alpha

      - run: amber --version

  test-cache-disabled:
    name: Test with cache disabled
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - uses: ./
        with:
          amber-version: 0.4.0-alpha
          enable-cache: false

      - run: amber --version

  test-custom-cache-path:
    name: Test with custom cache path
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - uses: ./
        with:
          amber-version: 0.4.0-alpha
          cache-path: /tmp/amber-test-cache

      - run: amber --version

  test-custom-bin-path:
    name: Test with custom cache path
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - uses: ./
        with:
          amber-version: 0.4.0-alpha
          bin-path: ./

      - run: ./amber --version

  test-repository-ref:
    name: Test amber-repository-ref
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - uses: ./
        with:
          amber-repository-ref: 75a57027775f56b4044439346f2cd33df80645f9

      - run: |
          which amber
          amber --version
          amber --version | grep -q 75a5702
          echo 'echo(trust ls("."))' > test.ab
          amber build test.ab
          bash test.sh

  test-output:
    name: Test amber-path output
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - id: setup
        uses: ./
        with:
          amber-version: 0.5.1-alpha

      - env:
          AMBER_PATH: ${{ steps.setup.outputs.amber-path }}
        run: |
          echo "Amber path output: $AMBER_PATH"
          if [ -z "$AMBER_PATH" ]; then
            echo "Error: amber-path output is empty"
            exit 1
          fi
          if [ ! -x "$AMBER_PATH" ]; then
            echo "Error: amber-path does not point to an executable file"
            exit 1
          fi
          echo "amber-path output is valid"
